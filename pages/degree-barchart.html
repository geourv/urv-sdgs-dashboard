<!DOCTYPE html>
<html lang="ca">
<head>
  <title>ODS per ensenyaments</title>
  <script src="../assets/js/head-loader.js"></script>
</head>
<body class="w3-light-grey">

<!-- page content -->
<div class="w3-main" style="margin-left:300px;margin-top:43px;">

  <!-- header -->
  <header class="w3-container" style="padding-top:22px">
  <h5><b><i class="fa fa-eye"></i> Una primera ullada > ODS per ensenyaments. Gràfic de barres</b></h5>
  </header>

  <div class="w3-container">
    <h1>ODS per Ensenyaments</h1>
    <p>Explora com s’alineen els ensenyaments de la URV amb els Objectius de Desenvolupament Sostenible.</p>
  </div>

  <!-- interactive section -->
  <div class="w3-container">
    <div class="interactive-chart-container" style="display:flex; flex-wrap:wrap;">

      <!-- left column -->
      <div class="left-col">
        <strong>Selecciona una facultat i un ensenyament per veure els ODS més freqüents.</strong>

        <div class="selector-container">
          <div class="selector-box">
            <select id="faculty-select" class="w3-select w3-border" onchange="updateDegreeSelect()">
              <option value="">-- Selecciona una facultat --</option>
            </select>
          </div>
          <div class="selector-box">
            <select id="degree-select" class="w3-select w3-border" onchange="updateBarChart()" disabled>
              <option value="">-- Selecciona un ensenyament --</option>
            </select>
          </div>
        </div>

        <strong>Amb els filtres de sota, també pots veure la presència d'ODS en diferents parts de la guia docent. </strong>

        <!-- filter tabs -->
        <div class="filter-container">
          <div class="filter-tabs">
            <div class="filter-tab" data-filter="descriptive" onclick="changeFilter(this, 'degrees_sdg_data_descriptive.json')">Títol, descripció i continguts</div>
            <span class="filter-symbol">+</span>
            <div class="filter-tab" data-filter="competencial" onclick="changeFilter(this, 'degrees_sdg_data_competencial.json')">Competències i resultats d'aprenentatge</div>
            <span class="filter-symbol">+</span>
            <div class="filter-tab" data-filter="bibliographical" onclick="changeFilter(this, 'degrees_sdg_data_bibliographical.json')">Bibliografia</div>
            <span class="filter-symbol">=</span>
            <div class="filter-tab active" data-filter="complete" onclick="changeFilter(this, 'degrees_sdg_data.json')">Guia docent completa</div>
          </div>
        </div>
      </div><!-- fi columna esquerra -->

      <!-- right column -->
<!-- right column -->
<div class="right-col">
  <!-- header compacte -->
  <div id="chart-info">
    <h3 id="title-inline"></h3>
    <div id="chart-meta"></div>
  </div>

  <!-- caixa del canvas amb altura fixa -->
  <div class="chart-canvas-box">
    <canvas id="interactive-bar-chart"></canvas>
  </div>

  <!-- llegenda sota el gràfic -->
  <div id="sdg-legend-inline" class="sdg-legend"></div>
</div>


    </div>
  </div>

  <!-- chart libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

  <script>
    // --- SDG labels and colors ---
    const sdgDefinitions = {
      "ODS-01":"Fi de la pobresa","ODS-02":"Fam zero","ODS-03":"Salut i benestar","ODS-04":"Educació de qualitat",
      "ODS-05":"Igualtat de gènere","ODS-06":"Aigua neta i sanejament","ODS-07":"Energia neta i assequible",
      "ODS-08":"Treball digne i creixement econòmic","ODS-09":"Indústria, innovació i infraestructura",
      "ODS-10":"Reducció de les desigualtats","ODS-11":"Ciutats i comunitats sostenibles","ODS-12":"Producció i consum responsables",
      "ODS-13":"Acció climàtica","ODS-14":"Vida submarina","ODS-15":"Vida d'ecosistemes terrestres",
      "ODS-16":"Pau, justícia i institucions sòlides","ODS-17":"Aliança per assolir els objectius"
    };
    const sdgColors = {
      "ODS-01":"#e5243b","ODS-02":"#dda63a","ODS-03":"#4c9f38","ODS-04":"#c5192d","ODS-05":"#ff3a21","ODS-06":"#26bde2",
      "ODS-07":"#fcc30b","ODS-08":"#a21942","ODS-09":"#fd6925","ODS-10":"#dd1367","ODS-11":"#fd9d24","ODS-12":"#bf8b2e",
      "ODS-13":"#3f7e44","ODS-14":"#0a97d9","ODS-15":"#56c02b","ODS-16":"#00689d","ODS-17":"#19486a"
    };

    // --- legend ---
    function createSDGLegend(containerId) {
      const el = document.getElementById(containerId);
      el.innerHTML = '';
      for (const [code, name] of Object.entries(sdgDefinitions)) {
        const item = document.createElement('div');
        item.className = 'sdg-legend-item';
        item.innerHTML =
          '<div class="sdg-color" style="background-color:'+sdgColors[code]+';"></div>'+
          '<span class="sdg-code">'+code+'</span>'+
          '<span class="sdg-name">'+name+'</span>';
        el.appendChild(item);
      }
    }

    // --- compact header above chart ---
    function showChartInfo({ faculty, degree, courses_per_degree, sdg_courses_degree, sdg_ratio_degree }) {
      const wrap = document.getElementById('chart-info');
      document.getElementById('title-inline').textContent = degree;
      document.getElementById('chart-meta').innerHTML =
        `<strong>Facultat:</strong> ${faculty} · `+
        `<strong>Total d'assignatures:</strong> ${courses_per_degree} · `+
        `<strong>Amb ODS:</strong> ${sdg_courses_degree} · `+
        `<strong>Ràtio:</strong> ${sdg_ratio_degree}%`;
      wrap.style.display = 'block';
    }
    function hideChartInfo(){
      const w = document.getElementById('chart-info');
      if (w) w.style.display = 'none';
    }

    // --- state ---
    let facultiesData = [];
    let currentFilter = 'degrees_sdg_data.json';

    // --- filter tabs ---
    function changeFilter(element, file) {
      document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
      element.classList.add('active');
      currentFilter = file;
      loadFacultiesData();
    }

    // --- data loading ---
    async function loadFacultiesData() {
      try {
        const resp = await fetch(`../data/${currentFilter}`);
        if (!resp.ok) throw new Error('Failed to load data');
        facultiesData = await resp.json();

        // normalize SDG->ODS keys
        facultiesData.forEach(f => f.degrees?.forEach(d => {
          if (d.percentages) {
            const p = {};
            Object.keys(d.percentages).forEach(k => p[k.replace('SDG','ODS')] = d.percentages[k]);
            d.percentages = p;
          }
          if (d.sdgs) {
            const s = {};
            Object.keys(d.sdgs).forEach(k => s[k.replace('SDG','ODS')] = d.sdgs[k]);
            d.sdgs = s;
          }
        }));

        const facultySelect = document.getElementById('faculty-select');
        const degreeSelect  = document.getElementById('degree-select');
        const prevFaculty = facultySelect.value;
        const prevDegree  = degreeSelect.value;

        updateFacultySelect();

        if (prevFaculty) {
          facultySelect.value = prevFaculty;
          updateDegreeSelect();
          const f = facultiesData.find(x => x.faculty === prevFaculty);
          if (f?.degrees?.some(d => d.degree === prevDegree)) {
            degreeSelect.value = prevDegree;
            updateBarChart();
          } else {
            degreeSelect.value = '';
            updateBarChart();
          }
        } else {
          updateBarChart();
        }
      } catch (e) {
        console.error('Data loading error:', e);
      }
    }

    // --- populate selects ---
    function updateFacultySelect() {
      const sel = document.getElementById('faculty-select');
      sel.innerHTML = '<option value="">-- Selecciona una facultat --</option>';
      facultiesData.forEach(f => {
        const opt = document.createElement('option');
        opt.value = f.faculty; opt.textContent = f.faculty;
        sel.appendChild(opt);
      });
    }

    function updateDegreeSelect() {
      const faculty = document.getElementById('faculty-select').value;
      const sel = document.getElementById('degree-select');
      sel.innerHTML = '<option value="">-- Selecciona un ensenyament --</option>';
      sel.disabled = !faculty;

      if (faculty) {
        const f = facultiesData.find(x => x.faculty === faculty);
        f?.degrees?.forEach(d => {
          const opt = document.createElement('option');
          opt.value = d.degree; opt.textContent = d.degree;
          sel.appendChild(opt);
        });
      }
      updateBarChart();
    }

    // --- chart ---
    function initInteractiveBarChart() {
      const ctx = document.getElementById('interactive-bar-chart').getContext('2d');
      window.interactiveBarChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(sdgDefinitions),
          datasets: [{
            label: "Percentatge d'ODS",
            data: Array(Object.keys(sdgDefinitions).length).fill(0),
            backgroundColor: Object.keys(sdgDefinitions).map(k => sdgColors[k]),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true, max: 20, title: { display: true, text: 'Percentatge (%)' } },
            x: { title: { display: true, text: 'Objetius de Desenvolupament Sostenible (ODS)' } }
          },
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: c => {
              const code = c.label, name = sdgDefinitions[code] || '';
              return `${code}: ${name} - ${c.parsed.y}%`;
            }}}
          }
        }
      });
    }

    function updateBarChart() {
      const fac = document.getElementById('faculty-select').value;
      const deg = document.getElementById('degree-select').value;

      if (!fac || !deg) {
        hideChartInfo();
        if (window.interactiveBarChart) {
          window.interactiveBarChart.data.datasets[0].data =
            Array(Object.keys(sdgDefinitions).length).fill(0);
          window.interactiveBarChart.data.datasets[0].label = "Percentatge d'ODS";
          window.interactiveBarChart.update();
        }
        return;
      }

      const f = facultiesData.find(x => x.faculty === fac);
      const d = f?.degrees?.find(y => y.degree === deg);
      if (!d) return;

      showChartInfo({
        faculty: fac, degree: deg,
        courses_per_degree: d.courses_per_degree,
        sdg_courses_degree: d.sdg_courses_degree,
        sdg_ratio_degree: d.sdg_ratio_degree
      });

      const labels = Object.keys(sdgDefinitions);
      const data = labels.map(s => d.percentages[s] || 0);
      window.interactiveBarChart.data.datasets[0].data = data;
      window.interactiveBarChart.data.datasets[0].label = `Percentatge d'ODS - ${deg}`;
      window.interactiveBarChart.update();
    }

    // --- boot ---
    document.addEventListener('DOMContentLoaded', () => {
      createSDGLegend('sdg-legend-inline');
      initInteractiveBarChart();
      loadFacultiesData();
    });
  </script>

  <script src="../assets/js/topbar-loader.js" defer></script>
  <script src="../assets/js/sidebar-loader.js" defer></script>
  <script src="../assets/js/footer-loader.js" defer></script>
</div>
</body>
</html>
